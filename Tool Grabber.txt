-- ⚡ ULTRA TOOL GRABBER — PHASE-LOCKED, SUCCESS-DRIVEN FINAL FORM ⚡

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local Tycoons = workspace:WaitForChild("Tycoons")

-- === SIGNALS (DO NOT TOUCH) ===
local Signals = ReplicatedStorage:WaitForChild("LocalSignals")
local RespawnPhase = Signals:WaitForChild("RespawnPhase")

-- === CONFIG ===
local RESPAWN_BURSTS  = 14
local RESPAWN_TOUCHES = 10
local ACTIVE_BURSTS   = 6
local ACTIVE_TOUCHES  = 6
local IDLE_BURSTS     = 2
local IDLE_TOUCHES    = 2

-- === BASE FILTERS ===
local allowedBases  = { Stone=true, Magic=true, Storm=true, Robotic=true }
local excludedBases = { Insanity=true, Giant=true, Dark=true, Spike=true, Web=true, Strong=true }

-- === PAD CACHE ===
local pads = {}
local matchedAllowedBase = false

local function registerPad(p)
	local base = p.Parent and p.Parent.Parent
	if not base then return end

	if excludedBases[base.Name] then return end

	if allowedBases[base.Name] then
		matchedAllowedBase = true
	end

	if next(allowedBases) and not allowedBases[base.Name] then
		return
	end

	pads[#pads+1] = p
end

-- === INITIAL PAD SCAN ===
for _, d in ipairs(Tycoons:GetDescendants()) do
	if d:IsA("TouchTransmitter")
	and d.Parent
	and d.Parent.Parent
	and d.Parent.Parent.Name:find("GearGiver1") then
		registerPad(d.Parent)
	end
end

-- === FALLBACK (SECOND GAME SUPPORT) ===
if not matchedAllowedBase then
	table.clear(pads)
	for _, d in ipairs(Tycoons:GetDescendants()) do
		if d:IsA("TouchTransmitter")
		and d.Parent
		and d.Parent.Parent
		and d.Parent.Parent.Name:find("GearGiver1") then
			pads[#pads+1] = d.Parent
		end
	end
end

-- === DYNAMIC PAD ADD ===
Tycoons.DescendantAdded:Connect(function(d)
	if d:IsA("TouchTransmitter")
	and d.Parent
	and d.Parent.Parent
	and d.Parent.Parent.Name:find("GearGiver1") then
		registerPad(d.Parent)
	end
end)

-- === ROOT AUTHORITY ===
local root, fakeRoot
local inRespawn = false

local function getHRP()
	return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
end

local function ensureFakeRoot()
	if fakeRoot then return end
	fakeRoot = Instance.new("Part")
	fakeRoot.Size = Vector3.new(2,2,1)
	fakeRoot.Transparency = 1
	fakeRoot.Anchored = true
	fakeRoot.CanCollide = false
	fakeRoot.Parent = workspace
	root = fakeRoot
end

local function tryAdoptRealRoot()
	local hrp = getHRP()
	if hrp then
		root = hrp
		if fakeRoot then
			fakeRoot:Destroy()
			fakeRoot = nil
		end
	end
end

-- === TOUCH CORE ===
local function touch(r, p)
	pcall(firetouchinterest, r, p, 0)
	pcall(firetouchinterest, r, p, 1)
end

local function blast(bursts, touches)
	if not root then return end
	for _, pad in ipairs(pads) do
		for _ = 1, bursts do
			for _ = 1, touches do
				touch(root, pad)
			end
		end
	end
end

-- === PHASE CONTROL (DO NOT TOUCH) ===
RespawnPhase.Event:Connect(function(phase)
	if phase == "Dying" then
		inRespawn = true
		ensureFakeRoot()
	elseif phase == "Respawning" then
		inRespawn = true
	end
end)

-- === HEARTBEAT CORE ===
RunService.Heartbeat:Connect(function()
	if not root then
		ensureFakeRoot()
	end

	if inRespawn then
		tryAdoptRealRoot()
	end

	if inRespawn then
		blast(RESPAWN_BURSTS, RESPAWN_TOUCHES)
	else
		blast(ACTIVE_BURSTS, ACTIVE_TOUCHES)
	end
end)

print("⚡ ULTRA TOOL GRABBER — MULTI-GAME COMPATIBLE & PHASE-LOCKED ONLINE")